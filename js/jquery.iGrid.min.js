;(function ( $, window, document, undefined ) {

    var pluginName = "iGrid",
        defaults = {
        };

    function Plugin( element, options ) {
        this.element = element;

        this.options = $.extend( {}, defaults, options );

        this._defaults = defaults;
        this._name = pluginName;

        this.init();
    }

    Plugin.prototype = {

        init: function() {
            this.getElements(this.element, this.options);
			this.setGrid(this.element, this.options);
			this.squareGrid(this.element, this.options);
			this.drawGrid(this.element, this.options);
			this.resize(this.element, this.options);
        },

		getElements: function(el, options){
			
			var target = $(el).children().children();
			var container_beg = "<div>";
			var container_end = "</div>"
			options.size = target.length;
			
			target.each(function(index){
				$(this).attr("cell", index);
				$(this).addClass("tile");
			});
		},

        setGrid: function(el, options) {
			var grid = [];
			var array = [];
			var cols;
					
			if(typeof options.rows != "undefined"){
				cols = Math.ceil(options.size / options.rows);
			} else {
				cols = options.columns;
			}
			
			var target = $(el).children();
			var counter = 0;
			
			target.each(function(){
				var row = $(this).children();
				row.each(function(index){
					array.push(counter);
					counter++;
				});
				grid.push(array);
				array = [];
			});
			
			grid.push(array);
			options.grid = grid;
        },

		squareGrid: function(el, options){
			var target = $(el).children('div');
			var addCol = 1;
			
			target.each(function(rows){
				$(this).children().each(function(cols){
					if($(this).outerWidth() > "247"){
						options.grid[rows].splice((cols*1 + addCol), 0, ".");
						addCol++;
					}
				});
				addCol = 1;
			});
			
			addCol = 1;
			
			target.each(function(rows){
				$(this).children().each(function(cols){
					if($(this).outerHeight() > "247"){
						options.grid[(rows*1)+1].splice((cols*1 + addCol), 0, ".");
						addCol++;
					}
				});
				addCol = 1;
			});
		},

		drawGrid: function(el, options){
			var width = options.width,
				height = options.height;
			
			var top = 0;
			var left = 0;
			var target = $(el).children().children();
			
			
			for(var rows in options.grid){
				top = rows * height;
				for(var cols in options.grid[rows]){
					var element = target[options.grid[rows][cols]];
					if(options.grid[rows][cols] != "."){
						$(target[options.grid[rows][cols]]).css('top',top+'px').css('left',left + 'px');
					}
					left += (width) *1;
				}
				left = 0;
			}
		},
		
		resize: function(el, options){
			var target = $(el).children();
			var targetWidth = 0;
			
			$(el).width(options.width * options.grid[0].length)
			$(el).height(options.width * (options.grid.length - 1));
			
		}
    };

    $.fn[pluginName] = function ( options ) {
        return this.each(function () {
            if (!$.data(this, "plugin_" + pluginName)) {
                $.data(this, "plugin_" + pluginName, new Plugin( this, options ));
            }
        });
    };

})( jQuery, window, document );